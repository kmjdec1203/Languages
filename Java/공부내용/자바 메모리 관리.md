# 자바 메모리 관리

`JVM`은 시스템(운영체제)으로부터 프로그램을 실행하는 데 필요한 메모리를 할당받고 할당 받은 메모리를 용도에 따라 세 영역으로 나누어 관리한다.

---

## 메서드 영역(method area)

프로그램 실행 중 특정 클래스가 사용되면, JVM은 해당 클래스의 클래스파일(*.class)을 읽어서 분석한 다음 클래스에 대한 정보를 이곳에 저장하게 된다. 이때 `클래스변수` 나 `메서드` 도 이 영역에 함께 생성된다.

`main()` 에서 클래스에 선언된 변수에 접근할 수 없는 것도 이러한 이유이다. `main()` 은 `static` 으로 선언되어 있기 때문에 클래스에 선언된 멤버변수(인스턴스 변수)를 사용할 수 없으며 인스턴스의 변수들은 힙 영역에 생성되기 때문에 인스턴스를 통해서만 접근이 가능하다.

## 힙 영역(heap area)

프로그램 실행 중 생성되는 `인스턴스` 는 모두 이곳에 생성된다. 즉, 인스턴스 변수들이 생성되는 공간으로 대부분의 메모리 공간은 힙 영역이 된다.

서버 시스템이나 메모리 사용이 많은 프로그램을 개발하거나 실행할 때 힙 메모리 부족으로 문제가 발생할 수 있으며 이 경우 `JVM 메모리 옵션` 을 조정해 주어야 한다.

## 호출 스택(call stack or execution stack)

호출 스택은 `메서드 실행`에 필요한 메모리 공간이다. 메서드가 호출될 때 호출 스택에는 호출된 메서드를 위한 메모리가 할당되며 이 메모리는 메서드가 작업을 수행하는 동안 `지역변수 및 매개변수`들의 연산 중간 결과 등을 저장하는 데 사용된다. 메서드가 작업을 마치면 할당되었던 메모리 공간은 반환되어 정리(비워짐)된다.

지역변수들의 경우 멤버변수나 다른 함수에서 사용된 변수들과 이름이 같아도 문제가 없는 이유이다.

## 가비지 컬렉션(garbage collection)

줄여서 `GC`라고도 한다.  자바에서 사용되지 않는 메모리를 정리해주는 작업이라고 할 수 있다. GC과정은 전체적인 `JVM의 성능에 영향`을 미치는 요소이기 때문에 오랜 시간 동안 발전을 거듭해 오늘에 이르게 되었다. 가비지 컬렉터(garbage collector)는 가비지 컬렉션을 수행하는 주체가 된다.

규모가 크지 않거나 특히 `컨테이너 기반`에서 동작하는 (웹서버(WAS) 프로그램이나 안드로이드 등) 프로그램들의 경우 일반 개발자들이 신경쓸 일이 많지 않고 개발자가 직접 `System.gc()`를 이용해 가비지 컬렉션을 동작시키는 것은 `권장되지 않는다`.

![img](https://dinfree.com/lecture/language/img/java2.png)

[그림] Java Heap 메모리 구조

### New/Young 영역

* Eden : 객체들이 최초로 생성되는 공간
* Survivor 0/1 : Eden에서 참조되는 객체들이 저장되는 공간

### Old 영역

* New area에서 일정 시간 참조되고 있는, 살아남은 객체들이 저장되는 공간. Eden영역에 객체가 가득차게 되면 첫 번째 GC(minor GC)가 발생함.
* Eden 영역에 있는 값들은 Survivor 1 영역에 복사되고 이 영역을 제외한 나머지 영역의 객체들은 삭제됨

### Permanent Generation

* 생성된 객체들의 정보의 주소값이 저장된 공간
* Class loader에 의해 load 되는 Class, Method 등에 대한 Meta 정보가 저장되는 영역
* JVM에 의해 실행됨

#### 프로그램 내에서 GC 대상이 되는 것은 다음과 같다.

* 모든 객체 참조가 null인 경우
* 객체가 블럭 안에서 생성되고 블럭이 종료된 경우
* 부모 객체가 null인 경우, 자식 객체는 자동적으로 GC 대상
* 객체가 Weak 참조만 가지고 있을 경우
* 객체가 Soft 참조이지만 메모리 부족이 발생한 경우

### 자바 객체 참조

> 좀 더 메모리를 고려하는 프로그램을 개발해야 하는 경우 단순히 `new`가 아니라 `Weak Reference` 혹은 `Soft Reference`를 이용해 객체를 생성해야 적절한 메모리 관리가 이루어 진다.

`Strong Reference`

* 일반적으로 new를 통해서 객체를 생성할 때 발생하는 참조 유형
* 가비지 컬렉션의 대상에서 제외

`Soft Reference`

* 강한 참조와는 다르게 GC에 의해 수거될 수도 있고, 수거되지 않을 수도 있음
* 메모리에 충분한 여유가 있다면 GC에 의해 수거되지 않음
* out of memory의 시점에 가깝다면 수거될 확률이 높다.

`Weak Reference`

* 약한 참조는 GC가 발생하면 무조건 수거됨
* Weak Reference가 사라지는 시점이 GC의 실행 주기와 일치하여 이를 이용하여 짧은 주기에 자주 사용되는 객체를 캐시할 때 유용